services:
# ----------------------------------------------------
  # Flask Web 打印应用 (Web Print Service)
  # ----------------------------------------------------
  web_print_app:
    image: web-print-app:latest
    container_name: web_print_app
    restart: unless-stopped
    depends_on:
      - cups_server # 确保 CUPS 启动后再启动 Web App
    # 映射 Web App 端口，例如到主机的 8000
    # 注意：如果您的 SWAG 正在反向代理，可以不暴露端口，只通过内部网络访问
    ports:
      - "5000:5000" 
    volumes:
      # 持久化上传文件和配置
      - ./data/web_app/uploads:/usr/src/app/uploads
      - ./data/web_app/instance:/usr/src/app/instance
      - /etc/localtime:/etc/localtime:ro
    environment:
      # 关键配置：指定 CUPS 服务器的地址和端口
      # 在 Docker Compose 中，服务名称 (cups_server) 即为 DNS 名称
      CUPS_SERVER: cups_server 
      CUPS_PORT: 631
      # 用于 Pycups 连接和 lp 命令的用户
      FLASK_USER: john 
      # PUID 和 PGID 确保 volumes 权限正确
      PUID: ${PUID}
      PGID: ${PGID}
      TZ: ${TZ}
    # 非 Root 运行：假设您在 Dockerfile 中创建了 'john' 用户并配置了权限
    # user: john # 在 Dockerfile 中定义的用户
    #networks:
      #- public_server

  # ----------------------------------------------------
  # CUPS 打印服务 (Print Server)
  # ----------------------------------------------------
  cups_server:
    image: olbat/cupsd # 或其他可靠的 CUPS 镜像
    container_name: cups_print_server
    restart: unless-stopped
    # 将容器的 631 端口映射到主机的 631 端口
    ports:
      - "631:631" 
    volumes:
      # 持久化 CUPS 配置
      - ./data/cups/config:/etc/cups
      # CUPS 打印池和日志
      - ./data/cups/spool:/var/spool/cups
      # 挂载打印机设备（对于 USB 连接是必需的）
      - /dev/bus/usb:/dev/bus/usb
      - /etc/localtime:/etc/localtime:ro
    # 特权模式：访问底层 /dev 设备通常需要
    privileged: true 
    # CUPS 默认通常以非 root 用户运行，但为了确保，您可能需要在 Dockerfile 中配置
    # 对于 olbat/cupsd 等预构建镜像，通常不需要指定 user/PUID/PGID
    # user: "${PUID}:${PGID}" # 仅当镜像支持 PUID/PGID 时使用
    #networks:
    #  - public_server # 使用您已定义的公共网络	  